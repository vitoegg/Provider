name: Update Rules

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

env:
  RULE_CHINA_PATH: RuleSet/Direct/China.list
  RULE_CHINA_URLS: >-
    https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/ChinaMax/ChinaMax_Domain.list
    https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/direct.txt
    https://raw.githubusercontent.com/vitoegg/Provider/master/RuleSet/Direct/LocalNet.list
  
  RULE_APPLE_PATH: RuleSet/Apple/Service.list
  RULE_APPLE_URLS: >-
    https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Apple/Apple_Domain.list
    https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/apple.txt
    https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/icloud.txt
  
  RULE_REJECT_PATH: RuleSet/Extra/Reject.list
  RULE_REJECT_URLS: >-
    https://ruleset.skk.moe/List/domainset/reject.conf
    https://ruleset.skk.moe/List/domainset/reject_extra.conf
    https://raw.githubusercontent.com/vitoegg/Provider/master/RuleSet/Extra/Privacy.list
    https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge.list

jobs:
  update-rules:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        id: checkout
        with:
          fetch-depth: 1

      - name: Setup Timezone
        run: sudo timedatectl set-timezone "Asia/Shanghai"
        id: timezone

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
        id: python

      - name: Create Processing Script
        id: create_script
        run: |
          cat > process_rules.sh << 'EOF'
          #!/bin/bash
          set -eo pipefail

          get_rules_config() {
            local -n rule_list="$1"
            local -n file_list="$2"
            
            echo "æ­£åœ¨æŸ¥æ‰¾è§„åˆ™é…ç½®..."
            
            for var in $(env | grep "^RULE_.*_PATH=" | cut -d= -f1); do
              local rule_name=${var%_PATH}
              rule_name=${rule_name#RULE_}
              
              local url_var="RULE_${rule_name}_URLS"
              
              if [[ -v $url_var ]]; then
                local path=${!var}
                local urls=${!url_var}
                
                echo "æ‰¾åˆ°è§„åˆ™é›†: $rule_name"
                echo "- ä¿å­˜ä½ç½®: $path"
                echo "- ä¸‹è½½åœ°å€æ•°é‡: $(echo "$urls" | wc -w)"
                
                rule_list["$rule_name"]="$path;$urls"
                file_list+=("$path")
              fi
            done
            
            echo "å…±æ‰¾åˆ° ${#rule_list[@]} ä¸ªè§„åˆ™é›†"
          }

          process_rule() {
            local rule_name="$1"
            local output_path="$2"
            local urls="$3"
            
            local output_dir=$(dirname "$output_path")
            mkdir -p "$output_dir"
            
            # åˆ›å»ºä¸´æ—¶æ—¥å¿—æ–‡ä»¶
            local log_file="$output_path.tmp.log"
            touch "$log_file"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" | tee -a "$log_file"
            echo "â”ƒ ğŸ”„ è§„åˆ™é›†å¤„ç†: $rule_name" | tee -a "$log_file"
            echo "â”ƒ ğŸ“ ä¿å­˜ä½ç½®: $output_path" | tee -a "$log_file"
            echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" | tee -a "$log_file"
            
            local start_time=$SECONDS
            
            echo "â”ƒ â¬‡ï¸ æ­£åœ¨ä¸‹è½½è§„åˆ™æ•°æ®..." | tee -a "$log_file"
            
            local merged_file=$(mktemp)
            local cleaned_file=$(mktemp)
            local tmp_dir=$(mktemp -d)
            
            local download_count=0
            local download_pids=()
            
            for url in $urls; do
              local tmp_file="${tmp_dir}/download_${download_count}"
              
              (curl -sL --fail --connect-timeout 10 --max-time 30 "$url" > "$tmp_file" && 
               echo "â”ƒ   âœ… ä¸‹è½½æˆåŠŸ: $url" || 
               echo "â”ƒ   âŒ ä¸‹è½½å¤±è´¥: $url") &
              
              download_pids+=($!)
              download_count=$((download_count + 1))
            done
            
            for pid in "${download_pids[@]}"; do
              wait $pid
            done
            
            echo "â”ƒ ğŸ”„ æ­£åœ¨åˆå¹¶å’Œæ¸…ç†è§„åˆ™æ•°æ®..." | tee -a "$log_file"
            
            cat "${tmp_dir}"/download_* > "$merged_file"
            
            sed -e 's/[[:space:]]*[#;\/\/].*$//' \
                -e 's/^[[:space:]]*//;s/[[:space:]]*$//' \
                -e '/^$/d' \
                -e '/^[[:space:]]*[#;\/\/]/d' \
                -e '/^payload:/d' \
                -e '/^[[:space:]]*\/\*/d;/\*\//d' \
                "$merged_file" > "$cleaned_file"
            
            local cleaned_count=$(wc -l < "$cleaned_file")
            echo "â”ƒ ğŸ“Š æ¸…ç†åçš„è§„åˆ™æ¡æ•°: $cleaned_count" | tee -a "$log_file"
            
            if [[ -s "$cleaned_file" ]]; then
              echo "â”ƒ ğŸ§¹ æ­£åœ¨å¯¹è§„åˆ™è¿›è¡Œæ¸…æ´—..." | tee -a "$log_file"
              
              local final_file=$(mktemp)
              
              echo "â”ƒ   â–¶ï¸ ä½¿ç”¨Pythonè„šæœ¬è¿›è¡Œè§„åˆ™æ¸…æ´—..." | tee -a "$log_file"
              
              script_path="${GITHUB_WORKSPACE}/Script/Workflow/process_rules.py"
              chmod +x "$script_path"
              
              local stats_file=$(mktemp)
              
              python3 "$script_path" "$cleaned_file" > "$final_file" 2> "$stats_file"
              python_exit=$?
              
              if [ $python_exit -ne 0 ]; then
                echo "â”ƒ   âš ï¸ Pythonè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ¸…æ´—æ–¹æ³•" | tee -a "$log_file"
                echo "â”ƒ   ğŸ”´ é”™è¯¯ä¿¡æ¯: $(cat "$stats_file")" | tee -a "$log_file"
                sort -u "$cleaned_file" > "$final_file"
              else
                echo "â”ƒ   ğŸ“‹ å¤„ç†ç»Ÿè®¡:" | tee -a "$log_file"
                while IFS= read -r line; do
                  echo "â”ƒ     $line" | tee -a "$log_file"
                done < "$stats_file"
                echo "â”ƒ   âœ… è§„åˆ™æ¸…æ´—å®Œæˆ" | tee -a "$log_file"
              fi
              
              rm -f "$stats_file"
              
              local final_count=$(wc -l < "$final_file")
              local removed_count=$((cleaned_count - final_count))
              echo "â”ƒ ğŸ“Š å»é‡åçš„è§„åˆ™æ¡æ•°: $final_count (å‡å°‘äº† $removed_count æ¡é‡å¤è§„åˆ™)" | tee -a "$log_file"
              
              echo "â”ƒ ğŸ“ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆè§„åˆ™æ–‡ä»¶..." | tee -a "$log_file"
              
              local meta_file=$(mktemp)
              
              {
                echo "# è§„åˆ™æ¥æº:"
                for url in $urls; do
                  repo_url=$(echo "$url" | sed -E 's|raw.githubusercontent.com/([^/]+/[^/]+).*|github.com/\1|')
                  echo "# - https://$repo_url"
                done
                echo ""
                cat "$final_file"
              } > "$meta_file"
              
              local changed=0
              local new_rules_count=$(grep -v "^#" "$meta_file" | wc -l)
              local old_rules_count=0
              local added_rules=0
              local removed_rules=0
              
              echo "â”ƒ ğŸ“Š æœ€æ–°è§„åˆ™æ–‡ä»¶åŒ…å« $new_rules_count æ¡è§„åˆ™" | tee -a "$log_file"
              
              if [ -f "$output_path" ]; then
                local old_file=$(mktemp)
                grep -v "^# Update time:" "$output_path" > "$old_file"
                
                old_rules_count=$(grep -v "^#" "$old_file" | wc -l)
                echo "â”ƒ ğŸ“Š ä»“åº“ä¸­å·²æœ‰è§„åˆ™æ–‡ä»¶åŒ…å« $old_rules_count æ¡è§„åˆ™" | tee -a "$log_file"
                
                # æ¯”è¾ƒå®é™…è§„åˆ™å†…å®¹è€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶
                local old_rules_content=$(mktemp)
                local new_rules_content=$(mktemp)
                
                # æå–å¹¶æ’åºè§„åˆ™å†…å®¹è¿›è¡Œæ¯”è¾ƒ
                grep -v "^#" "$old_file" | sort > "$old_rules_content"
                grep -v "^#" "$meta_file" | sort > "$new_rules_content"
                
                if ! cmp -s "$old_rules_content" "$new_rules_content"; then
                  changed=1
                  
                  # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨è§„åˆ™ (ä¸å«æ³¨é‡Š)
                  local old_rules="$old_rules_content"
                  local new_rules="$new_rules_content"
                  
                  # è®¡ç®—æ–°å¢çš„è§„åˆ™
                  local added_rules_file=$(mktemp)
                  comm -23 "$new_rules" "$old_rules" > "$added_rules_file"
                  added_rules=$(wc -l < "$added_rules_file")
                  
                  # è®¡ç®—åˆ é™¤çš„è§„åˆ™
                  local removed_rules_file=$(mktemp)
                  comm -13 "$new_rules" "$old_rules" > "$removed_rules_file"
                  removed_rules=$(wc -l < "$removed_rules_file")
                  
                  echo "â”ƒ ğŸ“‹ è§„åˆ™å˜åŒ–è¯¦æƒ…:" | tee -a "$log_file"
                  echo "â”ƒ   â• æ–°å¢è§„åˆ™: $added_rules æ¡" | tee -a "$log_file"
                  echo "â”ƒ   â– ç§»é™¤è§„åˆ™: $removed_rules æ¡" | tee -a "$log_file"
                  
                  # åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºå˜åŒ–çš„è§„åˆ™ï¼ˆæœ€å¤šæ˜¾ç¤º20æ¡ï¼‰
                  if [ $added_rules -gt 0 ]; then
                    if [ $added_rules -gt 20 ]; then
                      echo "â”ƒ ğŸ“‹ æ–°å¢è§„åˆ™é¢„è§ˆ(å‰20æ¡):" | tee -a "$log_file"
                      while IFS= read -r line; do
                        echo "â”ƒ   + $line" | tee -a "$log_file"
                      done < <(head -n 20 "$added_rules_file")
                      echo "â”ƒ   ... ä»¥åŠå…¶ä»– $((added_rules - 20)) æ¡è§„åˆ™" | tee -a "$log_file"
                    else
                      echo "â”ƒ ğŸ“‹ æ–°å¢è§„åˆ™åˆ—è¡¨:" | tee -a "$log_file"
                      while IFS= read -r line; do
                        echo "â”ƒ   + $line" | tee -a "$log_file"
                      done < "$added_rules_file"
                    fi
                  fi
                  
                  if [ $removed_rules -gt 0 ]; then
                    if [ $removed_rules -gt 20 ]; then
                      echo "â”ƒ ğŸ“‹ ç§»é™¤è§„åˆ™é¢„è§ˆ(å‰20æ¡):" | tee -a "$log_file"
                      while IFS= read -r line; do
                        echo "â”ƒ   - $line" | tee -a "$log_file"
                      done < <(head -n 20 "$removed_rules_file")
                      echo "â”ƒ   ... ä»¥åŠå…¶ä»– $((removed_rules - 20)) æ¡è§„åˆ™" | tee -a "$log_file"
                    else
                      echo "â”ƒ ğŸ“‹ ç§»é™¤è§„åˆ™åˆ—è¡¨:" | tee -a "$log_file"
                      while IFS= read -r line; do
                        echo "â”ƒ   - $line" | tee -a "$log_file"
                      done < "$removed_rules_file"
                    fi
                  fi
                  
                  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                  rm -f "$old_rules_content" "$new_rules_content" "$added_rules_file" "$removed_rules_file"
                else
                  echo "â”ƒ ğŸ”„ è§„åˆ™å¯¹æ¯”: å†…å®¹å®Œå…¨ç›¸åŒï¼Œæ— éœ€æ›´æ–°" | tee -a "$log_file"
                  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                  rm -f "$old_rules_content" "$new_rules_content"
                fi
                rm -f "$old_file"
              else
                changed=1
                added_rules=$new_rules_count
                echo "â”ƒ ğŸ“ æ–°å»ºè§„åˆ™æ–‡ä»¶ï¼Œå…±æ·»åŠ  $added_rules æ¡è§„åˆ™" | tee -a "$log_file"
              fi
              
              # æ€»ç»“è§„åˆ™çŠ¶æ€
              echo "â”ƒ ğŸ“Š è§„åˆ™æ›´æ–°æ‘˜è¦:" | tee -a "$log_file"
              echo "â”ƒ   ğŸ“„ æ–‡ä»¶: $(basename "$output_path")" | tee -a "$log_file"
              echo "â”ƒ   ğŸ”¢ æœ€æ–°è§„åˆ™æ¡æ•°: $new_rules_count" | tee -a "$log_file"
              echo "â”ƒ   ğŸ”¢ åŸæœ‰è§„åˆ™æ¡æ•°: $old_rules_count" | tee -a "$log_file"
              echo "â”ƒ   â• æ–°å¢è§„åˆ™æ¡æ•°: $added_rules" | tee -a "$log_file"
              echo "â”ƒ   â– ç§»é™¤è§„åˆ™æ¡æ•°: $removed_rules" | tee -a "$log_file"
              echo "â”ƒ   ğŸ”„ æ˜¯å¦æœ‰å˜æ›´: $([ $changed -eq 1 ] && echo 'æ˜¯' || echo 'å¦')" | tee -a "$log_file"
              
              if [ $changed -eq 1 ]; then
                {
                  echo "# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                  cat "$meta_file"
                } > "$output_path"
                echo "â”ƒ âœ… è§„åˆ™å·²æˆåŠŸæ›´æ–°" | tee -a "$log_file"
              else
                echo "â”ƒ â„¹ï¸ è§„åˆ™æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°" | tee -a "$log_file"
              fi
              
              rm -f "$final_file" "$meta_file"
            else
              echo "â”ƒ âš ï¸ è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå†…å®¹ï¼Œè·³è¿‡å¤„ç†" | tee -a "$log_file"
            fi
            
            rm -f "$merged_file" "$cleaned_file"
            rm -rf "$tmp_dir"
            
            local duration=$((SECONDS - start_time))
            echo "â”ƒ â±ï¸ å¤„ç†å®Œæˆï¼Œç”¨æ—¶: $duration ç§’" | tee -a "$log_file"
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" | tee -a "$log_file"
          }

          main() {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ ğŸš€ ç½‘ç»œè§„åˆ™æ›´æ–°å·¥å…·"
            echo "â”ƒ ğŸ•’ å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            declare -A rule_configs
            declare -a rule_files
            # ä¿å­˜æ¯ä¸ªè§„åˆ™æ–‡ä»¶çš„å˜æ›´çŠ¶æ€
            declare -A rule_changes
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ ğŸ” è§„åˆ™é…ç½®æ£€æŸ¥"
            echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            get_rules_config rule_configs rule_files
            
            if [ ${#rule_configs[@]} -eq 0 ]; then
              echo "â”ƒ âŒ æ²¡æœ‰æ‰¾åˆ°è§„åˆ™é…ç½®ï¼Œç¨‹åºç»“æŸ"
              echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              return
            fi
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            local start_time=$SECONDS
            
            for rule_name in "${!rule_configs[@]}"; do
              IFS=';' read -r output_path urls <<< "${rule_configs[$rule_name]}"
              
              process_rule "$rule_name" "$output_path" "$urls"
              
              # è®°å½•è§„åˆ™æ–‡ä»¶çš„å˜æ›´çŠ¶æ€
              if [ -f "$output_path" ]; then
                # è¯»å–process_ruleå‡½æ•°ä¸­çš„changedå˜é‡ï¼Œé€šè¿‡æ£€æŸ¥æ–‡ä»¶å†…å®¹åˆ¤æ–­
                # å¦‚æœæ–‡ä»¶ä¸­åŒ…å«"æ˜¯å¦æœ‰å˜æ›´: æ˜¯"ï¼Œåˆ™æ ‡è®°ä¸ºå·²å˜æ›´
                if grep -q "æ˜¯å¦æœ‰å˜æ›´: æ˜¯" "$output_path.tmp.log" 2>/dev/null || \
                   grep -q "è§„åˆ™å·²æˆåŠŸæ›´æ–°" "$output_path.tmp.log" 2>/dev/null; then
                  rule_changes["$output_path"]=true
                else
                  rule_changes["$output_path"]=false
                fi
                rm -f "$output_path.tmp.log" 2>/dev/null || true
              fi
            done
            
            local duration=$((SECONDS - start_time))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ âœ… æ‰€æœ‰è§„åˆ™å¤„ç†å®Œæˆ"
            echo "â”ƒ â±ï¸ æ€»ç”¨æ—¶: $((duration / 60))åˆ†$((duration % 60))ç§’"
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            local has_changes=false
            local change_summary=""
            local total_added=0
            local total_removed=0
            
            # å°†æ‰€æœ‰è§„åˆ™æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºä»¥æ£€æŸ¥å˜åŒ–
            git add "${rule_files[@]}" 2>/dev/null || true
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ ğŸ“‹ è§„åˆ™å˜æ›´æ€»ç»“"
            echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            for file in "${rule_files[@]}"; do
              if [ -f "$file" ]; then
                local file_changed=${rule_changes["$file"]:-false}
                
                # è·å–è§„åˆ™æ•°é‡ï¼ˆä¸å«æ³¨é‡Šï¼‰
                local new_count_file=$(mktemp)
                awk '!/^#/' "$file" > "$new_count_file"
                local new_count=$(wc -l < "$new_count_file")
                rm -f "$new_count_file"
                
                local basename=$(basename "$file")
                
                echo "â”ƒ ğŸ“„ æ–‡ä»¶: $basename"
                echo "â”ƒ   ğŸ”¢ è§„åˆ™æ¡æ•°: $new_count"
                echo "â”ƒ   ğŸ”„ æ˜¯å¦æœ‰å˜æ›´: $([ "$file_changed" = "true" ] && echo "æ˜¯" || echo "å¦")"
                
                # å¦‚æœæœ‰å˜æ›´ï¼Œä»git diffä¸­è·å–å˜æ›´è¯¦æƒ…
                if [ "$file_changed" = "true" ]; then
                  has_changes=true
                  
                  # æå–è§„åˆ™ç±»å‹åç§° (å»æ‰.liståç¼€)
                  local rule_name=$(basename "$file" .list)
                  
                  # ä»process_ruleå‡½æ•°ä¸­è·å–å˜æ›´è¡Œæ•°
                  local added_lines=0
                  local removed_lines=0
                  
                  # å°è¯•ä»git diffä¸­è·å–å˜æ›´è¡Œæ•°
                  local diff_file=$(mktemp)
                  git diff --cached --no-color "$file" > "$diff_file"
                  
                  # è¿‡æ»¤æ‰æ›´æ–°æ—¶é—´çš„å˜åŒ–
                  local filtered_diff=$(mktemp)
                  awk '!/^[+-]# Update time:/' "$diff_file" > "$filtered_diff"
                  
                  # è®¡ç®—å˜æ›´è¡Œæ•°
                  local add_count=$(grep -c "^+" "$filtered_diff" || echo 0)
                  local del_count=$(grep -c "^-" "$filtered_diff" || echo 0)
                  
                  # å¦‚æœæ— æ³•ä»git diffè·å–ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
                  added_lines=$add_count
                  removed_lines=$del_count
                  
                  # æ›´æ–°å˜æ›´æ‘˜è¦
                  change_summary="${change_summary}${rule_name}(+${added_lines}/-${removed_lines}) "
                  
                  # æ›´æ–°æ€»è®¡
                  total_added=$((total_added + added_lines))
                  total_removed=$((total_removed + removed_lines))
                  
                  rm -f "$filtered_diff" "$diff_file"
                fi
                
                echo "â”ƒ   ---------------------------"
              fi
            done
            
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â”ƒ ğŸ“ æäº¤ç»“æœ"
            
            if [ "$has_changes" = true ]; then
              # ç§»é™¤æœ«å°¾çš„ç©ºæ ¼
              change_summary=$(echo "$change_summary" | sed 's/ $//')
              echo "â”ƒ âœ… æ–°çš„æäº¤ä¿¡æ¯: Update rules: $change_summary"
              
              if [ -n "$GITHUB_OUTPUT" ]; then
                echo "has_changes=true" >> $GITHUB_OUTPUT
                echo "change_summary=${change_summary}" >> $GITHUB_OUTPUT
              fi
            else
              echo "â”ƒ â„¹ï¸ æ€»ç»“: æ‰€æœ‰è§„åˆ™æ–‡ä»¶å‡æ— å˜åŒ–"
              
              if [ -n "$GITHUB_OUTPUT" ]; then
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
              # å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œæ¢å¤æš‚å­˜åŒº
              git restore --staged "${rule_files[@]}" 2>/dev/null || true
            fi
            echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          }

          main
          EOF
          
          chmod +x process_rules.sh

      - name: Update RuleSets
        id: check_changes
        run: ./process_rules.sh

      - name: Commit and Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update rules: ${{ steps.check_changes.outputs.change_summary }}"
          git push
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 2